-- Complete Autotrade Script for Loadstring
-- Place this code at: https://raw.githubusercontent.com/your-username/autotrade/main/sender

-- Configuration is handled by the user's getgenv().Settings table

-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Game-specific references (verify these paths match your game)
local Localdata = require(ReplicatedStorage:WaitForChild("LocalData"))
local Network = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Framework"):WaitForChild("Network"):WaitForChild("RemoteEvent")

-- Trade state tracking
local tradeOpen = false
local tradeCompleted = false
local currentTradeUser = ""

-- Function to check if a pet matches the user's filter criteria
local function petMatchesFilter(petData)
    local nameMatch = table.find(getgenv().Settings.PETS_TO_TRADE, petData.Name)
    local mythicMatch = (not getgenv().Settings.ONLY_MYTHIC) or petData.Mythic
    local shinyMatch = (not getgenv().Settings.ONLY_SHINY) or petData.Shiny
    
    return nameMatch and mythicMatch and shinyMatch
end

-- Function to add pets to trade
local function addPetsToTrade()
    local petsAdded = 0
    
    for _, petData in pairs(Localdata.Pets) do
        if petMatchesFilter(petData) then
            -- Use the correct remote to add pet to trade
            local success, errorMsg = pcall(function()
                Network:FireServer("TradeAddPet", petData.Id .. ":0")
            end)
            
            if success then
                petsAdded = petsAdded + 1
                print("Added pet to trade: " .. petData.Name)
                task.wait(0.5) -- Delay between adding pets
            else
                warn("Failed to add pet " .. petData.Name .. ": " .. tostring(errorMsg))
            end
        end
    end
    
    return petsAdded
end

-- Main trading process
local function executeTrade()
    print("Starting trade process with user: " .. getgenv().Settings.TRADE_USER)
    
    -- Step 1: Send trade request
    local requestSuccess, requestResult = pcall(function()
        Network:FireServer("TradeRequest", getgenv().Settings.TRADE_USER)
    end)
    
    if not requestSuccess then
        warn("Failed to send trade request: " .. tostring(requestResult))
        return false
    end
    
    print("Trade request sent. Waiting for acceptance...")
    
    -- Step 2: Wait for trade to open (with timeout)
    local tradeWaitTime = 0
    local maxWaitTime = 30 -- 30 second timeout
    
    while not tradeOpen and tradeWaitTime < maxWaitTime do
        task.wait(1)
        tradeWaitTime = tradeWaitTime + 1
    end
    
    if not tradeOpen then
        warn("Trade did not open within timeout period")
        return false
    end
    
    print("Trade opened successfully")
    task.wait(2) -- Brief pause before adding pets
    
    -- Step 3: Add pets to trade
    local petsAdded = addPetsToTrade()
    
    if petsAdded == 0 then
        warn("No pets matching the filter criteria were found or added")
        -- Depending on your needs, you might want to cancel the trade here
    end
    
    print("Added " .. petsAdded .. " pets to trade")
    task.wait(2) -- Wait for other player to see pets
    
    -- Step 4: Accept the trade
    local acceptSuccess, acceptResult = pcall(function()
        Network:FireServer("TradeAccept")
    end)
    
    if not acceptSuccess then
        warn("Failed to accept trade: " .. tostring(acceptResult))
        return false
    end
    
    print("Trade accepted. Waiting for confirmation...")
    task.wait(3)
    
    -- Step 5: Confirm the trade
    local confirmSuccess, confirmResult = pcall(function()
        Network:FireServer("TradeConfirm")
    end)
    
    if not confirmSuccess then
        warn("Failed to confirm trade: " .. tostring(confirmResult))
        return false
    end
    
    print("Trade confirmed. Waiting for completion...")
    
    -- Step 6: Wait for trade completion
    local completeWaitTime = 0
    local maxCompleteWait = 15
    
    while not tradeCompleted and completeWaitTime < maxCompleteWait do
        task.wait(1)
        completeWaitTime = completeWaitTime + 1
    end
    
    if tradeCompleted then
        print("Trade completed successfully!")
        return true
    else
        warn("Trade completion not detected within timeout")
        return false
    end
end

-- Listen for trade state changes (adapt to your game's actual remote events)
Network.OnClientEvent:Connect(function(action, ...)
    if action == "TradeOpened" then
        tradeOpen = true
        tradeCompleted = false
        print("Trade opened event received")
    elseif action == "TradeEnded" then
        tradeOpen = false
        tradeCompleted = true
        print("Trade ended event received")
        -- Optional: Add any post-trade cleanup here
    end
end)

-- Main execution flow
local function main()
    print("Autotrade script started")
    print("Looking for pets: " .. table.concat(getgenv().Settings.PETS_TO_TRADE, ", "))
    
    -- First, check if the target user is in the current server
    local targetPlayer = Players:FindFirstChild(getgenv().Settings.TRADE_USER)
    
    if targetPlayer then
        print("Trade user found in current server")
        
        -- Check if we have the required pets
        local hasRequiredPets = false
        for _, petData in pairs(Localdata.Pets) do
            if petMatchesFilter(petData) then
                hasRequiredPets = true
                break
            end
        end
        
        if hasRequiredPets then
            print("Required pets found. Starting trade...")
            local success = executeTrade()
            
            if success then
                print("Trade process completed")
            else
                warn("Trade process failed")
            end
        else
            print("No pets matching the criteria found in inventory")
        end
    else
        print("Trade user not found in current server")
        
        -- Check if we should teleport to the target job
        if getgenv().Settings.JOBID and getgenv().Settings.JOBID ~= "" then
            -- Check if we have the required pets before teleporting
            local shouldTeleport = false
            for _, petData in pairs(Localdata.Pets) do
                if petMatchesFilter(petData) then
                    shouldTeleport = true
                    break
                end
            end
            
            if shouldTeleport then
                print("Teleporting to target server...")
                local teleportSuccess, teleportError = pcall(function()
                    TeleportService:TeleportToPlaceInstance(game.PlaceId, getgenv().Settings.JOBID, LocalPlayer)
                end)
                
                if not teleportSuccess then
                    warn("Teleport failed: " .. tostring(teleportError))
                end
            else
                print("No matching pets found, not teleporting")
            end
        else
            print("No JOBID specified for teleport")
        end
    end
end

-- Start the script
main()
