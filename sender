local remote = game:GetService("ReplicatedStorage").Shared.Framework.Network.Remote.RemoteEvent
local server = game:GetService("TeleportService")
local localdata = require(game:GetService("ReplicatedStorage").Client.Framework.Services.LocalData)
local data = localdata:Get()
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Settings and stuffs

local Settings = getgenv().Settings
local PETS_TO_TRADE = Settings.PETS_TO_TRADE
local ONLY_MYTHIC = Settings.ONLY_MYTHIC
local ONLY_SHINY = Settings.ONLY_SHINY
local JOBID = Settings.JOBID
local TRADE_USER = Settings.TRADE_USER

local tradeplayer = game.Players:FindFirstChild(TRADE_USER)



local serverhop = false
local tradenow = false
local tradeopen = false

local allowedpets = {}






function getdata()
    data = localdata:Get()
end 

function checkpets()
    getdata()
    table.clear(allowedpets)

    if not data.Pets then
        print("No pets found")
        return false
    end

    for _, pet in pairs(data.Pets) do
        for _, wanted in ipairs(PETS_TO_TRADE) do
            if pet.Name == wanted then
                -- Check if pet.Id already has :0 suffix
                local petId = pet.Id
                if not string.find(petId, ":0$") then
                    petId = petId .. ":0"  -- Add :0 if missing
                end
                
                table.insert(allowedpets, petId)  -- Store the full ID with :0
                print("Found pet:", pet.Name, "| ID:", petId)
                break
            end
        end
    end

    print("Total pets to trade:", #allowedpets)
    return #allowedpets > 0
end



if game.JobId == JOBID then
    serverhop = false
    print("alr in server :3")
    tradenow = true
else
    server:TeleportToPlaceInstance(game.PlaceId, JOBID, LocalPlayer)
end

remote.OnClientEvent:Connect(function(action)
    if action == "TradeOpened" then
        print("Trade started")
        tradeopen = true
    elseif action == "TradeEnded" then
        print("Trade ended")
        tradeopen = false
    end
end)

while true do
    if tradenow and Players:FindFirstChild(TRADE_USER) then
        checkpets()
        task.wait(0.5)
        print("trading starting")
        task.wait(1)
        if not tradeopen then
            remote:FireServer("TradeRequest", tradeplayer)
            task.wait(10)
            for _, petId in ipairs(allowedpets) do  -- Change petData to petId
                remote:FireServer("TradeAddPet", petId)  -- petId is already the string ID
                task.wait(1)
                print("adding pet ID:", petId)  -- Just print the ID
            end
            task.wait(2)
            remote:FireServer("TradeAccept")
            task.wait(10)
            remote:FireServer("TradeConfirm")
            task.wait(15)
            game.Players.LocalPlayer:Kick("Pets traded :P")
        end
    elseif tradenow and not Players:FindFirstChild(TRADE_USER) then
        print("user to trade not found")
        break
    end
    task.wait(1)

end



