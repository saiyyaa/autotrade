local remote = game:GetService("ReplicatedStorage").Shared.Framework.Network.Remote.RemoteEvent
local server = game:GetService("TeleportService")
local localdata = require(game:GetService("ReplicatedStorage").Client.Framework.Services.LocalData)
local data = localdata:Get()
local Players = game:GetService("Players")

-- Settings and stuffs
local Settings = getgenv().Settings
local PETS_TO_TRADE = Settings.PETS_TO_TRADE
local ONLY_MYTHIC = Settings.ONLY_MYTHIC
local ONLY_SHINY = Settings.ONLY_SHINY
local JOBID = Settings.JOBID
local TRADE_USER = Settings.TRADE_USER

local serverhop = false
local tradenow = false
local tradeopen = false

local allowedpets = {}






function getdata()
    data = localdata:Get()
end 

function checkpets()
    getdata()
    table.clear(allowedpets)
    serverhop = false

    if not data.Pets then
        print("No pets found")
        return false
    end

    for _, pet in pairs(data.Pets) do
        for _, wanted in ipairs(PETS_TO_TRADE) do
            if pet.Name == wanted then
                table.insert(allowedpets, {
                    Id = pet.Id,
                    Name = pet.Name
                })

                print("allowed pet:", pet.Name, "| ID:", pet.Id)
                serverhop = true
                break
            end
        end
    end

    print("done")
    return serverhop, eligiblePets
end


if game.JobId == JOBID then
    serverhop = false
    print("alr in server :3")
    tradenow = true
else
    TeleportService:TeleportToPlaceInstance(game.PlaceId, JOBID, LocalPlayer)
end

Network.OnClientEvent:Connect(function(action)
    if action == "TradeOpened" then
        print("Trade started")
        tradeopen = true
    elseif action == "TradeEnded" then
        print("Trade ended")
        tradeopen = false
    end
end)

while true do
    if tradenow and Players:FindFirstChild(TRADE_USER) then
        checkpets()
        task.wait(0.5)
        print("trading starting")
        task.wait(1)
        if not tradeopen then
            remote:FireServer("TradeRequest", TRADE_USER)
            task.wait(10)
            for _, petid in ipairs(allowedpets) do
                remote:FireServer("TradeAddPet", petid)
                task.wait(1)
            end
            task.wait(2)
            remote:FireServer("TradeAccept")
            task.wait(10)
            remote:FireServer("TradeConfirm")
            task.wait(5)
            game.Players.LocalPlayer:Kick("Pets traded :P")
        end
    elseif tradenow and not Players:FindFirstChild(TRADE_USER) then
        print("user to trade not found")
        break
    end
    task.wait(1)

end



